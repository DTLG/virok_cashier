import 'dart:convert';
import 'dart:io';
import 'dart:typed_data';
import 'package:flutter/foundation.dart';
import 'package:enough_convert/enough_convert.dart';

/// –°–µ—Ä–≤—ñ—Å –¥–ª—è –¥—Ä—É–∫—É –≥–æ—Ç–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç—É –≤—ñ–¥ –í—á–∞—Å–Ω–æ –Ω–∞ –º–µ—Ä–µ–∂–µ–≤–∏–π –ø—Ä–∏–Ω—Ç–µ—Ä
class RawPrinterService {
  /// –î—Ä—É–∫—É—î –≥–æ—Ç–æ–≤–∏–π —Ç–µ–∫—Å—Ç –≤—ñ–¥ –í—á–∞—Å–Ω–æ –Ω–∞ –º–µ—Ä–µ–∂–µ–≤–∏–π –ø—Ä–∏–Ω—Ç–µ—Ä
  ///
  /// [printerIp] - IP-–∞–¥—Ä–µ—Å–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  /// [pfTextBase64] - Base64-—Ä—è–¥–æ–∫ —Ç–µ–∫—Å—Ç—É —á–µ–∫–∞ (pf_text –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –í—á–∞—Å–Ω–æ)
  /// [port] - –ü–æ—Ä—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 9100 –¥–ª—è RAW printing)
  Future<void> printVchasnoText({
    required String printerIp,
    required String pfTextBase64,
    int port = 9100,
  }) async {
    try {
      debugPrint("üñ®Ô∏è [PRINTER] –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞ $printerIp:$port");

      final socket = await Socket.connect(
        printerIp,
        port,
        timeout: const Duration(seconds: 5),
      );

      List<int> bytesToSend = [];

      // ---------------------------------------------------------
      // 1. –ö–û–ú–ê–ù–î–ò –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (HEADER)
      // ---------------------------------------------------------

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (ESC @)
      bytesToSend.addAll([0x1B, 0x40]);

      // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥–æ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (Code Page)
      // –í–ê–ñ–õ–ò–í–û: –î–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –∫–∏—Ç–∞–π—Å—å–∫–∏—Ö –ø—Ä–∏–Ω—Ç–µ—Ä—ñ–≤ (Xprinter)
      // 17 - —Ü–µ –∑–∞–∑–≤–∏—á–∞–π PC866 (–ö–∏—Ä–∏–ª–∏—Ü—è) –∞–±–æ Windows-1251.
      // –Ø–∫—â–æ –±—É–¥—É—Ç—å —ñ—î—Ä–æ–≥–ª—ñ—Ñ–∏ - —Å–ø—Ä–æ–±—É–π –∑–º—ñ–Ω–∏—Ç–∏ 17 –Ω–∞: 6, 16, 34, 73.
      bytesToSend.addAll([0x1B, 0x74, 17]);

      // ---------------------------------------------------------
      // 2. –¢–Ü–õ–û –ß–ï–ö–ê (BODY)
      // ---------------------------------------------------------

      // –û—á–∏—â–∞—î–º–æ Base64 –≤—ñ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–∞ "data:text/plain..."
      String cleanBase64 = pfTextBase64;
      if (pfTextBase64.contains(',')) {
        cleanBase64 = pfTextBase64.split(',').last;
      }

      // –î–µ–∫–æ–¥—É—î–º–æ Base64 —É –±–∞–π—Ç–∏.
      // –ú–∏ –ù–ï –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ —ó—Ö —É String (utf8), —â–æ–± –Ω–µ –∑–ª–∞–º–∞—Ç–∏ –∫–æ–¥—É–≤–∞–Ω–Ω—è!
      List<int> receiptBytes = base64Decode(cleanBase64);

      bytesToSend.addAll(receiptBytes);

      // ---------------------------------------------------------
      // 3. –ó–ê–í–ï–†–®–ï–ù–ù–Ø (FOOTER)
      // ---------------------------------------------------------

      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ (Feed 4 lines)
      bytesToSend.addAll([0x1B, 0x64, 0x04]);

      // –û–±—Ä—ñ–∑–∫–∞ (Cut)
      bytesToSend.addAll([0x1D, 0x56, 0x42, 0x00]);

      // ---------------------------------------------------------
      // 4. –í–Ü–î–ü–†–ê–í–ö–ê
      // ---------------------------------------------------------

      socket.add(Uint8List.fromList(bytesToSend));
      await socket.flush();
      await socket.close();

      debugPrint("‚úÖ [PRINTER] –ì–æ—Ç–æ–≤–∏–π —á–µ–∫ –≤—ñ–¥ –í—á–∞—Å–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä!");
    } catch (e) {
      debugPrint("‚ùå [PRINTER] –ü–æ–º–∏–ª–∫–∞ –¥—Ä—É–∫—É raw-—Ç–µ–∫—Å—Ç—É: $e");
      rethrow;
    }
  }

  /// –î—Ä—É–∫—É—î –±–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π —Å–ª—ñ–ø (—Ç–µ—Ä–º—ñ–Ω–∞–ª—å–Ω–∏–π —á–µ–∫) –Ω–∞ –º–µ—Ä–µ–∂–µ–≤–∏–π –ø—Ä–∏–Ω—Ç–µ—Ä
  ///
  /// [printerIp] - IP-–∞–¥—Ä–µ—Å–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
  /// [slipText] - –¢–µ–∫—Å—Ç –±–∞–Ω–∫—ñ–≤—Å—å–∫–æ–≥–æ —Å–ª—ñ–ø–∞ (–∑ –ø–æ–ª—è receipt –∞–±–æ sliptxt)
  /// [port] - –ü–æ—Ä—Ç –ø—Ä–∏–Ω—Ç–µ—Ä–∞ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 9100 –¥–ª—è RAW printing)
  Future<void> printBankSlip({
    required String printerIp,
    required String slipText,
    int port = 9100,
  }) async {
    try {
      debugPrint("üñ®Ô∏è [PRINTER] –î—Ä—É–∫—É—î–º–æ –±–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π —Å–ª—ñ–ø –Ω–∞ $printerIp:$port");

      final socket = await Socket.connect(
        printerIp,
        port,
        timeout: const Duration(seconds: 5),
      );

      List<int> bytesToSend = [];

      // ---------------------------------------------------------
      // 1. –ö–û–ú–ê–ù–î–ò –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø (HEADER)
      // ---------------------------------------------------------

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è (ESC @)
      bytesToSend.addAll([0x1B, 0x40]);

      // –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥–æ–≤–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (Code Page)
      // 17 - —Ü–µ –∑–∞–∑–≤–∏—á–∞–π PC866 (–ö–∏—Ä–∏–ª–∏—Ü—è) –∞–±–æ Windows-1251.
      // –Ø–∫—â–æ –±—É–¥—É—Ç—å —ñ—î—Ä–æ–≥–ª—ñ—Ñ–∏ - —Å–ø—Ä–æ–±—É–π –∑–º—ñ–Ω–∏—Ç–∏ 17 –Ω–∞: 6, 16, 34, 73.
      bytesToSend.addAll([0x1B, 0x74, 17]);

      // ---------------------------------------------------------
      // 2. –¢–Ü–õ–û –°–õ–Ü–ü–ê (BODY)
      // ---------------------------------------------------------

      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç —Å–ª—ñ–ø–∞ –≤ –±–∞–π—Ç–∏ Windows-1251
      // –ë–∞–Ω–∫ –¥–∞—î —Ç–µ–∫—Å—Ç –∑ \n, –ø—Ä–∏–Ω—Ç–µ—Ä —Ü–µ —Ä–æ–∑—É–º—ñ—î —è–∫ –ø–µ—Ä–µ–Ω–æ—Å
      final codec = const Windows1251Codec(allowInvalid: true);
      bytesToSend.addAll(codec.encode(slipText));

      // ---------------------------------------------------------
      // 3. –ó–ê–í–ï–†–®–ï–ù–ù–Ø (FOOTER)
      // ---------------------------------------------------------

      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ (Feed 4 lines)
      bytesToSend.addAll([0x1B, 0x64, 0x04]);

      // –û–±—Ä—ñ–∑–∫–∞ (Cut)
      bytesToSend.addAll([0x1D, 0x56, 0x42, 0x00]);

      // ---------------------------------------------------------
      // 4. –í–Ü–î–ü–†–ê–í–ö–ê
      // ---------------------------------------------------------

      socket.add(Uint8List.fromList(bytesToSend));
      await socket.flush();
      await socket.close();

      debugPrint("‚úÖ [PRINTER] –ë–∞–Ω–∫—ñ–≤—Å—å–∫–∏–π —Å–ª—ñ–ø –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–Ω—Ç–µ—Ä!");
    } catch (e) {
      debugPrint("‚ùå [PRINTER] –ü–æ–º–∏–ª–∫–∞ –¥—Ä—É–∫—É –±–∞–Ω–∫—ñ–≤—Å—å–∫–æ–≥–æ —Å–ª—ñ–ø–∞: $e");
      rethrow;
    }
  }
}
